<script>
	/**
	 * functions for auth form (backform)
	 * and for main form init 
	 */

	function handleLogin(){
		applyJudgeName();
		//changeView("backform","mainlayer"); // disabled now for comfortable debug
	}

	function applyJudgeName(){
		//puts name in disabled field 
		getJudgeElem().setAttribute("value", document.getElementById('jid').value);
		initForm();
		formToken();
	}

	function initForm(){
		//calls model data getters on server
		//handlers in module_client
		google.script.run.withFailureHandler(handleError).withSuccessHandler(
			OnTeamNamesFetched).getTeamnames(getIDValue());
		google.script.run.withFailureHandler(handleError).withSuccessHandler(
			OnFormParametersFetched).getParams(getIDValue());
		initElement();
		getTeamElem().focus();
	}

	function OnTeamNamesFetched(data){
		sessionStorage.setItem("teamnames", data);
	}

	function changeView(first	,second){
		//change forms disabled
		document.getElementById('' + first).setAttribute("hidden","true");
  		document.getElementById('' + second).removeAttribute("hidden");
	}



	/**
	 * functions for communication with server
	 */

	function sendForm(){
		// getSubmitButtonElem().setAttribute("disabled","disabled");
		var formData = getFormData();
		formData.formLink = $("li").length;
		$('#logslist').prepend("<li id='log" + formData.formLink + "'> Отправлено " + "</li>");
  		google.script.run.withFailureHandler(handleError).withSuccessHandler(handleServerResponse).handleClientForm(formData);
	}

	function getFormData(){
		//get all data from module
		// all getters should be in module file
		var FormResponse = {
    		team: getTeamValue(),
    		problem: getProblemValue(),
    		result: getResultValue(),
    		judge: getJudgeValue(),
    		version: getVersionValue(),
    		uptodate: true,
    		formLink: 0,
    		comment: getCommentValue(),
    		tableid: getIDValue(), //заглушка с константным id
    		serverResponse: "Записано",
    		token: document.getElementById("tokenval").value
  		};
  		return FormResponse;
	}

	function handleServerResponse(JSONresp){
		//alert(JSONresp);
		var resp = JSON.parse(JSONresp);
  		if(resp.uptodate == false){ 
    		initForm();
  		}
  		resetInput();
  		formToken();
		pushServerResponse(resp.formLink,resp.team,resp.problem,resp.result,resp.serverResponse);
	}

	function resetInput(){
		getProblemElem().value = "";
		getCommentElem().value = "";
		document.getElementById("good_radio").checked = false;
		document.getElementById("bad_radio").checked = false;
	}

	function pushServerResponse(link,a,b,c,d){
	  //push data to special structure
	  //var TeamNames = JSON.parse(sessionStorage.getItem("myKey"));
	  // instead of a - TeamNames[a - 1]
	  var teamnames = JSON.parse(sessionStorage.getItem("teamnames"));
	  document.getElementById("log"+link).innerText = teamnames[a-1] + 
	  	" (" +  a + ") " + "; " + b + "; " + c +  "; " + d + " ";
	}



	/**
	 * key functions
	 */

	function handleError(error){
		//write to special field
		document.getElementById("formMessage").innerText = error;
		formToken();
  		// getSubmitButtonElem().removeAttribute("disabled");
	}

	function initPage(){
		google.script.run.withSuccessHandler(setHeader).getHeader();
	}

	function setHeader(h){
		document.getElementById("header").innerText = h;
	}

	function formToken(){
		var d = new Date();
		$("#tokenval").val(getJudgeValue() + d.toLocaleTimeString());
	}

	function sleep(ms) {
  		return new Promise(resolve => setTimeout(resolve, ms));
	}

</script>
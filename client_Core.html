<script>
	/**
	 * functions for auth form (backform)
	 * and for main form init 
	 */

	function handleLogin(){
		applyJudgeName();
		//changeView("backform","mainlayer"); // disabled now for comfortable debug
	}

	function applyJudgeName(){
		//puts name in disabled field 
		getJudgeElem().setAttribute("value", document.getElementById('jid').value);
		initForm();
		formToken();
	}

	function initForm(){
		//calls model data getters on server
		//handlers in module_client
		google.script.run.withFailureHandler(handleError).withSuccessHandler(
			OnFormParametersFetched).getParams();
	}

	function changeView(first	,second){
		//change forms disabled
		document.getElementById('' + first).setAttribute("hidden","true");
  		document.getElementById('' + second).removeAttribute("hidden");
	}



	/**
	 * functions for communication with server
	 */

	function sendForm(){
		// getSubmitButtonElem().setAttribute("disabled","disabled");
		var formData = getFormData();
		formData.formLink = $("li").length;
		$('#logslist').prepend("<li> Sent... " + formData.formLink + "</li>");
  		google.script.run.withFailureHandler(handleError).withSuccessHandler(handleServerResponse).handleClientForm(formData);
  		//document.getElementById("formMessage").innerText = ("Отправлено");
	}

	function getFormData(){
		//get all data from module
		// all getters should be in module file
		var FormResponse = {
    		team: getTeamValue(),
    		problem: getProblemValue(),
    		result: getResultValue(),
    		judge: getJudgeValue(),
    		version: getVersionValue(),
    		uptodate: true,
    		formLink: 0,
    		comment: getCommentValue(),
    		tableid: getIDValue(),
    		serverResponse: "Success",
    		token: document.getElementById("tokenval").value
  		};
  		/*var FormResponse = {
    		team: 1,
    		problem: 1,
    		result: 1,
    		judge: "tester",
    		version: 5,
    		uptodate: true,
    		formLink: 0,
    		comment: "  ",
    		tableid: "1i60nTGNebrNBu83lodRgNGVtXRsyJHCcoQpC0h1Isug",
    		serverResponse: "Success"
  		};
  		*/
  		return FormResponse;
	}

	function handleServerResponse(JSONresp){
		//alert(JSONresp);
		//un(boxing)packing response, calling other handlers
		var resp = JSON.parse(JSONresp);
		var SuccessMessage = "Записано";
  		var FailureMessage = "Ошибка заполнения!"
		//checking for actual teamnames
		console.log(resp.uptodate);
  		if(resp.uptodate == false){ 
    		initForm();
  		}

  		switch(resp.serverResponse){   // reading serverResponse
		    case "Error":
		      SuccessMessage = FailureMessage;
		      break;
	  	}

  		handleError(SuccessMessage);      //Log and reset
		getProblemElem().value = "";
		getCommentElem().value = "";
		document.getElementById("good_radio").checked = false;
		document.getElementById("bad_radio").checked = false;
		//writing some numbers
		pushServerResponse(resp.formLink,resp.team,resp.problem,resp.result,resp.serverResponse);
	}

	function pushServerResponse(link,a,b,c,d){
	  //push data to special structure
	  //var TeamNames = JSON.parse(sessionStorage.getItem("myKey"));
	  // instead of a - TeamNames[a - 1]
	  $("#logslist li").filter(function(){
	  	//alert("A" + $(this).text());
	  	//alert("A" + " Sent..." + link);
    	return $(this).text() == (" Sent... " + link);
  	  }).text() = " " + a + "; " + b + "; " + c +  "; " + d + " ";
	  //$('#logslist').prepend("<li> " + a + "; " + b + "; " + c +  "; " + d + "; " + e + " </li>");
	}



	/**
	 * key functions
	 */

	function handleError(error){
		//write to special field
		document.getElementById("formMessage").innerText = error;
		formToken();
  		// getSubmitButtonElem().removeAttribute("disabled");
	}

	function initPage(){
		google.script.run.withSuccessHandler(setHeader).getHeader();
	}

	function setHeader(h){
		document.getElementById("header").innerText = h;
	}

	function formToken(){
		var d = new Date();
		$("#tokenval").val(getJudgeValue() + d.toLocaleTimeString());
	}

</script>